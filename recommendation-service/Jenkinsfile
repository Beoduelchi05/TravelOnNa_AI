pipeline {
    agent any
    
    environment {
        // Docker ì´ë¯¸ì§€ ê´€ë ¨
        DOCKER_IMAGE = 'travelonna-ai-recommendation'
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_REGISTRY = 'your-registry'  // ì‹¤ì œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ ë³€ê²½
        
        // Kubernetes ê´€ë ¨
        K8S_NAMESPACE = 'default'
        K8S_DEPLOYMENT = 'travelonna-ai-recommendation'
        
        // Git ê´€ë ¨
        GIT_BRANCH = 'main'
        
        // BuildKit í™œì„±í™”
        DOCKER_BUILDKIT = '1'
    }
    
    stages {
        stage('ğŸ—ï¸ Checkout') {
            steps {
                echo 'ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì¤‘...'
                checkout scm
                
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                }
            }
        }
        
        stage('ğŸ› ï¸ Setup Docker Buildx') {
            steps {
                echo 'ğŸ› ï¸ Docker Buildx ì„¤ì • ì¤‘...'
                sh '''
                    # Docker Buildx ë²„ì „ í™•ì¸
                    docker buildx version
                    
                    # Builder ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ì—†ì„ ê²½ìš°)
                    docker buildx create --name travelonna-builder --use --bootstrap || true
                    
                    # í˜„ì¬ builder í™•ì¸
                    docker buildx ls
                    
                    # BuildKit ê¸°ëŠ¥ í™•ì¸
                    docker buildx inspect --bootstrap
                '''
            }
        }
        
        stage('ğŸ§ª Test') {
            steps {
                echo 'ğŸ§ª Python í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...'
                sh '''
                    cd TravelOnNa_AI/recommendation-service
                    
                    # Python í™˜ê²½ í™•ì¸
                    python3 --version
                    pip3 --version
                    
                    # ì˜ì¡´ì„± ì„¤ì¹˜
                    pip3 install -r requirements.txt
                    
                    # ë¬¸ë²• ì²´í¬
                    python3 -m py_compile app/main.py
                    python3 -m py_compile app/services/*.py
                    python3 -m py_compile app/api/*.py
                    
                    echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
                '''
            }
        }
        
        stage('ğŸ³ Docker Buildx Build') {
            steps {
                echo 'ğŸ³ Docker Buildx ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘...'
                script {
                    dir('TravelOnNa_AI/recommendation-service') {
                        // Multi-platform ë¹Œë“œ (linux/amd64, linux/arm64)
                        sh """
                            docker buildx build \
                                --platform linux/amd64,linux/arm64 \
                                --tag ${DOCKER_IMAGE}:${DOCKER_TAG} \
                                --tag ${DOCKER_IMAGE}:latest \
                                --tag ${DOCKER_IMAGE}:${GIT_COMMIT_SHORT} \
                                --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                                --build-arg VCS_REF=${GIT_COMMIT_SHORT} \
                                --build-arg BUILD_NUMBER=${BUILD_NUMBER} \
                                --cache-from type=local,src=/tmp/.buildx-cache \
                                --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
                                --load \
                                .
                        """
                        
                        // ìºì‹œ êµì²´ (ì˜¤ë˜ëœ ìºì‹œ ì •ë¦¬)
                        sh '''
                            rm -rf /tmp/.buildx-cache
                            mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true
                        '''
                        
                        echo "âœ… Docker Buildx ë¹Œë“œ ì™„ë£Œ: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    }
                }
            }
        }
        
        stage('ğŸ” Image Security Scan') {
            steps {
                echo 'ğŸ” ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰ ì¤‘...'
                sh '''
                    # ì´ë¯¸ì§€ ì·¨ì•½ì  ìŠ¤ìº” (ì„ íƒì‚¬í•­)
                    # docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                    #   -v $(pwd):/app aquasec/trivy:latest image ${DOCKER_IMAGE}:${DOCKER_TAG}
                    
                    # ì´ë¯¸ì§€ ì •ë³´ í™•ì¸
                    docker images ${DOCKER_IMAGE}:${DOCKER_TAG}
                    docker inspect ${DOCKER_IMAGE}:${DOCKER_TAG} | head -20
                '''
            }
        }
        
        stage('ğŸš€ Deploy to K8s') {
            steps {
                echo 'ğŸš€ Kubernetes ë°°í¬ ì¤‘...'
                sh '''
                    cd TravelOnNa_AI/recommendation-service
                    
                    # ConfigMapê³¼ Secret ì ìš© (ì²˜ìŒ í•œ ë²ˆë§Œ)
                    kubectl apply -f k8s/configmap.yaml || true
                    
                    # ë°°í¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì—ì„œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
                    sed -i "s|image: travelonna-ai-recommendation:latest|image: travelonna-ai-recommendation:${DOCKER_TAG}|g" k8s/deployment.yaml
                    
                    # Kubernetes ë°°í¬
                    kubectl apply -f k8s/deployment.yaml
                    
                    # ë°°í¬ ìƒíƒœ í™•ì¸
                    kubectl rollout status deployment/${K8S_DEPLOYMENT} -n ${K8S_NAMESPACE} --timeout=300s
                    
                    # ì„œë¹„ìŠ¤ í™•ì¸
                    kubectl get pods -l app=${K8S_DEPLOYMENT} -n ${K8S_NAMESPACE}
                    kubectl get svc -l app=${K8S_DEPLOYMENT} -n ${K8S_NAMESPACE}
                '''
            }
        }
        
        stage('ğŸ©º Health Check') {
            steps {
                echo 'ğŸ©º í—¬ìŠ¤ì²´í¬ ì‹¤í–‰ ì¤‘...'
                sh '''
                    # ì„œë¹„ìŠ¤ IP ê°€ì ¸ì˜¤ê¸°
                    SERVICE_IP=$(kubectl get svc travelonna-ai-recommendation-service -o jsonpath='{.spec.clusterIP}')
                    
                    # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 5ë¶„ ëŒ€ê¸°)
                    for i in {1..30}; do
                        if curl -f http://${SERVICE_IP}:8000/health; then
                            echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
                            break
                        else
                            echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... ($i/30)"
                            sleep 10
                        fi
                    done
                '''
            }
        }
    }
    
    post {
        success {
            echo 'ğŸ‰ ë°°í¬ ì„±ê³µ!'
            // ì„±ê³µì‹œ ì•Œë¦¼ (Slack, ì´ë©”ì¼ ë“±)
        }
        failure {
            echo 'âŒ ë°°í¬ ì‹¤íŒ¨!'
            // ì‹¤íŒ¨ì‹œ ë¡¤ë°± ë° ì•Œë¦¼
            sh '''
                echo "ğŸ”„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°± ì¤‘..."
                kubectl rollout undo deployment/${K8S_DEPLOYMENT} -n ${K8S_NAMESPACE} || true
            '''
        }
        always {
            // ì •ë¦¬ ì‘ì—…
            sh '''
                # Docker ì´ë¯¸ì§€ ì •ë¦¬
                docker image prune -f || true
                
                # Buildx ìºì‹œ ì •ë¦¬ (ì£¼ê°„ 1íšŒ)
                if [ "$(date +%u)" = "1" ]; then
                    docker buildx prune -f || true
                fi
            '''
        }
    }
} 